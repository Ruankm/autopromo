<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'>
<title>WhatsApp Connection Status</title>
<style>
body{background:linear-gradient(135deg,#10b981,#059669);display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;font-family:Arial}
.box{background:white;padding:60px;border-radius:30px;text-align:center;box-shadow:0 30px 80px rgba(0,0,0,0.5);max-width:650px}
h1{color:#10b981;font-size:42px;margin:0 0 10px}
.loading{display:none;margin:30px 0}
.spinner{border:4px solid #f3f3f3;border-top:4px solid #10b981;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;margin:0 auto}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.qr-section{display:block}
.success-section{display:none;padding:40px;background:#dcfce7;border-radius:20px;margin:30px 0}
.success-section h2{color:#166534;margin:0 0 20px}
.info{background:#1f2937;color:#10b981;padding:25px;border-radius:15px;font-family:monospace;font-size:13px;margin-top:30px;text-align:left}
img{max-width:500px;width:100%;border:6px solid #10b981;border-radius:25px;margin:30px 0;box-shadow:0 15px 40px rgba(0,0,0,0.3)}
.error{color:#dc2626;background:#fee2e2;padding:20px;border-radius:10px;margin:20px 0}
</style>
</head>
<body>
<div class='box' id="app">
<h1>ðŸ“± WhatsApp Connection</h1>

<!-- LOADING STATE -->
<div class='loading' id="loading">
<div class='spinner'></div>
<p>Checking connection status...</p>
</div>

<!-- QR SECTION -->
<div class='qr-section' id="qr-section">
<h2>Scan QR Code</h2>
<img id="qr-image" src='' alt='QR Code'/>
<div class='info'>
<strong>Status:</strong> <span id="status-text">Loading...</span><br>
<strong>ID:</strong> <span id="connection-id"></span>
</div>
<p style='margin-top:30px;color:#6b7280'>
1. Open WhatsApp on your phone<br>
2. Tap â‹® (menu) â†’ Linked devices<br>
3. Tap "Link a device"<br>
4. Scan this QR Code
</p>
</div>

<!-- SUCCESS SECTION -->
<div class='success-section' id="success-section">
<h2>âœ… WhatsApp Connected!</h2>
<p style='font-size:18px;color:#166534'>Your WhatsApp is now connected and ready to use.</p>
<div class='info'>
<strong>Connection ID:</strong> <span id="success-id"></span><br>
<strong>Status:</strong> Connected<br>
<strong>Connected at:</strong> <span id="connected-time"></span>
</div>
</div>

<!-- ERROR SECTION -->
<div class='error' id="error-section" style='display:none'>
<strong>Error:</strong> <span id="error-text"></span>
</div>
</div>

<script>
// CONFIGURATION
const API_BASE = 'http://localhost:8000/api/v1';
const CONNECTION_ID = '__CONNECTION_ID__'; // Will be replaced by PowerShell
const POLL_INTERVAL = 3000; // 3 seconds

let pollTimer = null;

async function checkStatus() {
  try {
    const response = await fetch(`${API_BASE}/connections/${CONNECTION_ID}/status`, {
      headers: {
        'Authorization': 'Bearer __AUTH_TOKEN__' // Will be replaced by PowerShell
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    document.getElementById('status-text').textContent = data.status;
    document.getElementById('connection-id').textContent = CONNECTION_ID.substring(0, 8) + '...';
    
    if (data.status === 'connected') {
      // SHOW SUCCESS!
      document.getElementById('qr-section').style.display = 'none';
      document.getElementById('success-section').style.display = 'block';
      document.getElementById('success-id').textContent = CONNECTION_ID.substring(0, 8) + '...';
      document.getElementById('connected-time').textContent = new Date().toLocaleString();
      
      // STOP POLLING
      if (pollTimer) {
        clearInterval(pollTimer);
      }
    }
  } catch (error) {
    document.getElementById('error-section').style.display = 'block';
    document.getElementById('error-text').textContent = error.message;
  }
}

async function loadQR() {
  try {
    const response = await fetch(`${API_BASE}/connections/${CONNECTION_ID}/qr`, {
      headers: {
        'Authorization': 'Bearer __AUTH_TOKEN__'
      }
    });
    
    if (response.status === 202) {
      // Still generating
      setTimeout(loadQR, 2000);
      return;
    }
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.qr_code) {
      document.getElementById('qr-image').src = `data:image/png;base64,${data.qr_code}`;
      document.getElementById('loading').style.display = 'none';
      document.getElementById('qr-section').style.display = 'block';
      
      // START POLLING STATUS
      pollTimer = setInterval(checkStatus, POLL_INTERVAL);
    }
  } catch (error) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error-section').style.display = 'block';
    document.getElementById('error-text').textContent = error.message;
  }
}

// START
document.getElementById('loading').style.display = 'block';
document.getElementById('qr-section').style.display = 'none';
loadQR();
</script>
</body>
</html>
